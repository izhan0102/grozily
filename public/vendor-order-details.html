<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order Details - Grozily</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #F5F7FA;
            color: #2D3748;
            min-height: 100vh;
        }

        /* Mobile-first App Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background-color: #805AD5;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .order-details-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: #805AD5;
        }

        /* Order Details Content */
        .order-card {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
            border-left: 4px solid #805AD5;
        }

        /* Additional Styling for Order Details */
        .order-items-list {
            background: #F7FAFC;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }

        .order-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px dashed rgba(0,0,0,0.05);
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .order-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }

        .item-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background-color: #F0E7FF;
            margin-right: 12px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-size: 15px;
            color: #2D3748;
            margin: 0;
            font-weight: 500;
        }

        .item-quantity {
            font-size: 13px;
            color: #718096;
            margin: 4px 0 0 0;
        }

        .item-price {
            font-size: 16px;
            font-weight: 600;
            color: #805AD5;
            background: rgba(128, 90, 213, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .customer-info {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #EDF2F7;
        }

        .customer-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #F0E7FF;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #805AD5;
            font-size: 16px;
            flex-shrink: 0;
        }

        .customer-name {
            font-size: 16px;
            font-weight: 500;
            color: #2D3748;
        }

        .customer-details {
            font-size: 14px;
            color: #718096;
            margin-top: 5px;
        }

        .order-summary {
            margin-top: 15px;
            background: #F0E7FF;
            border-radius: 10px;
            padding: 12px 15px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
            color: #4A5568;
        }

        .summary-row.total {
            font-weight: 600;
            color: #2D3748;
            font-size: 16px;
            padding-top: 8px;
            margin-top: 5px;
            border-top: 1px dashed rgba(0,0,0,0.1);
        }

        /* Delivery Options */
        .delivery-options {
            margin-top: 25px;
        }

        .option-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .option-btn {
            background-color: white;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .option-btn i {
            font-size: 22px;
            color: #805AD5;
        }

        .option-btn.active {
            background-color: #F0E7FF;
            border-color: #805AD5;
            color: #805AD5;
        }

        .option-btn.locked {
            opacity: 0.7;
            cursor: not-allowed;
            position: relative;
        }

        .option-btn.locked::after {
            content: 'Coming Soon';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(74, 85, 104, 0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border-radius: 12px;
        }

        /* Status Checkpoints */
        .status-checkpoints {
            margin-top: 25px;
            display: none;
        }

        .checkpoint {
            background-color: white;
            border-radius: 10px;
            border: 1px solid #E2E8F0;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .checkpoint-header {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: #F9FAFB;
            border-bottom: 1px solid #E2E8F0;
        }

        .checkpoint-title {
            flex: 1;
            font-weight: 500;
            color: #2D3748;
        }

        .checkpoint-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.confirm {
            background-color: #F0FFF4;
            color: #38A169;
        }

        .action-btn.confirm:hover {
            background-color: #38A169;
            color: white;
        }

        .action-btn.cancel {
            background-color: #FFF5F5;
            color: #E53E3E;
        }

        .action-btn.cancel:hover {
            background-color: #E53E3E;
            color: white;
        }

        .checkpoint-content {
            padding: 15px;
            font-size: 14px;
            color: #718096;
        }

        .checkpoint.completed {
            border-color: #38A169;
            border-left: 4px solid #38A169;
        }

        .checkpoint.completed .checkpoint-header {
            background-color: #F0FFF4;
        }

        .checkpoint.completed .checkpoint-title {
            color: #38A169;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkpoint.completed .checkpoint-actions {
            display: none;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2D3748;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            max-width: 90%;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        .toast i {
            font-size: 18px;
        }

        .toast.success {
            background-color: #38A169;
        }

        .toast.error {
            background-color: #E53E3E;
        }

        .toast.info {
            background-color: #3182CE;
        }

        /* Update Loading Indicators */
        .updating {
            pointer-events: none;
            opacity: 0.7;
            position: relative;
        }

        .updating::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(128, 90, 213, 0.2);
            border-radius: 50%;
            border-top-color: #805AD5;
            animation: spin 1s linear infinite;
            top: calc(50% - 10px);
            right: 15px;
        }

        /* Loading state */
        .loading-state {
            text-align: center;
            padding: 30px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        .loading-state i {
            font-size: 30px;
            color: #805AD5;
            margin-bottom: 15px;
            display: block;
        }

        .loading-state p {
            color: #4A5568;
            margin-bottom: 10px;
        }

        .loading-state .loader {
            margin: 20px auto;
        }

        /* Error state */
        .error-state {
            text-align: center;
            padding: 30px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
            border-left: 4px solid #E53E3E;
        }

        .error-state i {
            font-size: 40px;
            color: #E53E3E;
            margin-bottom: 15px;
            display: block;
        }

        .error-state h3 {
            color: #2D3748;
            margin-bottom: 10px;
        }

        .error-state p {
            color: #4A5568;
            margin-bottom: 10px;
        }

        .error-state pre {
            text-align: left;
            background-color: #F7FAFC;
            padding: 10px;
            border-radius: 8px;
            overflow: auto;
            margin-top: 15px;
            font-size: 13px;
            color: #718096;
        }

        /* Status Badge Styles */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
            color: white;
            margin-left: 10px;
            text-transform: uppercase;
        }

        .status-pending {
            background-color: #718096;
        }

        .status-confirmed {
            background-color: #3182CE;
        }

        .status-packed {
            background-color: #805AD5;
        }

        .status-shipping {
            background-color: #DD6B20;
        }

        .status-delivered {
            background-color: #38A169;
        }

        .status-cancelled {
            background-color: #E53E3E;
        }

        /* Add additional styles for better mobile experience */
        @media (max-width: 480px) {
            .order-header h3 {
                font-size: 16px;
                display: flex;
                flex-wrap: wrap;
                align-items: center;
            }

            .status-badge {
                margin-left: 5px;
            }

            .option-btn span {
                font-size: 13px;
            }
        }

        /* Loader animation */
        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(128, 90, 213, 0.2);
            border-radius: 50%;
            border-top-color: #805AD5;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Order Header */
        .order-header {
            padding: 15px;
            border-bottom: 1px solid #EDF2F7;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <div class="app-header">
            <button id="back-btn" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="header-title">
                <i class="fas fa-file-invoice"></i>
                Order Details
            </h1>
            <div style="width: 40px;"></div> <!-- Spacer for alignment -->
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="order-details-container">
                <div id="order-details-content">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCtbwkusKvCEYNCHUytaF4tUISNywsADiM",
            authDomain: "grozily2.firebaseapp.com",
            databaseURL: "https://grozily2-default-rtdb.firebaseio.com",
            projectId: "grozily2",
            storageBucket: "grozily2.firebasestorage.app",
            messagingSenderId: "665300145710",
            appId: "1:665300145710:web:4f8d866e07fc902b1131bf",
            measurementId: "G-83S7ZWXEB9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // DOM Elements
        const backBtn = document.getElementById('back-btn');
        const orderDetailsContent = document.getElementById('order-details-content');

        // Show loading state with message
        function showLoading(message = 'Loading order details...') {
            orderDetailsContent.innerHTML = `
                <div class="loading-state">
                    <i class="fas fa-shopping-cart"></i>
                    <p>${message}</p>
                    <div class="loader"></div>
                </div>
            `;
        }

        // Show error state with details
        function showError(title, message, error = null) {
            console.error('Error in order details:', message, error);
            orderDetailsContent.innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>${title}</h3>
                    <p>${message}</p>
                    ${error ? `<pre>${typeof error === 'object' ? JSON.stringify(error, null, 2) : error}</pre>` : ''}
                    <button class="btn btn-primary" onclick="window.location.href='vendor-orders.html'">
                        <i class="fas fa-arrow-left"></i> Back to Orders
                    </button>
                </div>
            `;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Order details page loaded');
            
            // Show initial loading state
            showLoading('Initializing page...');
            
            // Back button
            backBtn.addEventListener('click', () => {
                window.location.href = 'vendor-orders.html';
            });

            // Check if user is authenticated
            firebase.auth().onAuthStateChanged(user => {
                if (!user) {
                    console.log('User not authenticated, redirecting to login');
                    window.location.href = 'vendor-login.html';
                } else {
                    console.log('User authenticated:', user.uid);
                    loadOrderDetails();
                }
            });
        });

        // Load order details based on URL or localStorage
        function loadOrderDetails() {
            // Show loading state
            showLoading('Fetching order information...');
            
            try {
                // Get order ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const orderId = urlParams.get('id');
                console.log('Order ID from URL:', orderId);
                
                if (!orderId) {
                    showError('Order Not Found', 'No order ID was provided in the URL.');
                    return;
                }
                
                // First try to get order from localStorage
                const storedOrderJson = localStorage.getItem('selectedOrder');
                console.log('Order data from localStorage available:', !!storedOrderJson);
                
                if (storedOrderJson) {
                    try {
                        const storedOrder = JSON.parse(storedOrderJson);
                        console.log('Successfully parsed order from localStorage');
                        
                        // Verify this is the correct order
                        if (storedOrder && storedOrder.id === orderId) {
                            console.log('Order ID matches the URL parameter, displaying order');
                            displayOrderDetails(storedOrder);
                            return;
                        } else {
                            console.log('Order ID mismatch, fetching from Firebase instead');
                        }
                    } catch (e) {
                        console.error('Error parsing stored order:', e);
                    }
                }
                
                // If we get here, we need to fetch from Firebase
                console.log('Fetching order from Firebase with ID:', orderId);
                fetchOrderFromFirebase(orderId);
                
            } catch (error) {
                console.error('Error in loadOrderDetails:', error);
                showError('Error Loading Order', 'An unexpected error occurred.', error);
            }
        }

        // Fetch order from Firebase
        function fetchOrderFromFirebase(orderId) {
            showLoading('Fetching order from database...');
            
            // First check orders collection
            firebase.database().ref(`orders/${orderId}`).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        console.log('Order found in orders collection');
                        const order = snapshot.val();
                        order.id = snapshot.key;
                        displayOrderDetails(order);
                        return;
                    }
                    
                    console.log('Order not found in orders collection, checking allOrders');
                    // Check allOrders collection if not found
                    return firebase.database().ref(`allOrders/${orderId}`).once('value')
                        .then(snapshot => {
                            if (snapshot.exists()) {
                                console.log('Order found in allOrders collection');
                                const order = snapshot.val();
                                order.id = snapshot.key;
                                displayOrderDetails(order);
                                return;
                            }
                            
                            // Order not found in either collection
                            console.log('Order not found in any collection');
                            showError('Order Not Found', 'Could not find the order in the database. It may have been deleted or does not exist.');
                        });
                })
                .catch(error => {
                    console.error('Error fetching order from Firebase:', error);
                    showError('Database Error', 'Failed to fetch order details from the database.', error);
                });
        }

        // Display order details in the UI
        function displayOrderDetails(order) {
            console.log('Displaying order details:', order);
            
            try {
                // Validate the order data
                if (!order || typeof order !== 'object') {
                    throw new Error('Invalid order data: ' + JSON.stringify(order));
                }
            
                // Get customer info
                const customerName = 
                    order.userName || 
                    order.user?.name || 
                    order.customerName || 
                    order.customer?.name || 
                    'Customer';
                    
                const customerInitial = customerName.charAt(0).toUpperCase();
                
                // Get order status
                const status = 
                    order.status || 
                    order.orderStatus || 
                    order.state || 
                    'pending';
                    
                const statusClass = getStatusClass(status);
                const statusText = getStatusText(status);
                
                // Calculate amounts
                let subtotal = 0;
                if (Array.isArray(order.items) && order.items.length > 0) {
                    subtotal = calculateSubtotal(order.items);
                } else {
                    // Try to get subtotal directly if no items
                    subtotal = parseFloat(order.subtotal) || 0;
                }
                
                const platformFeePercent = 5; // Assume 5% platform fee
                const platformFee = (subtotal * platformFeePercent) / 100;
                const vendorAmount = subtotal - platformFee;
                const deliveryFee = parseFloat(order.deliveryFee) || 0;
                const totalAmount = subtotal + deliveryFee;
                
                // Format order date
                const orderDate = new Date(order.createdAt || order.timestamp || Date.now());
                const formattedDate = formatDate(orderDate);
                
                // Build order items HTML
                let itemsHtml = '';
                if (Array.isArray(order.items) && order.items.length > 0) {
                    order.items.forEach(item => {
                        // Verify item is an object
                        if (!item || typeof item !== 'object') {
                            console.warn('Invalid item in order:', item);
                            return; // Skip this item
                        }
                    
                        // Get item details
                        const itemName = 
                            item.name || 
                            item.productName || 
                            item.title || 
                            'Product';
                            
                        const itemQuantity = 
                            item.quantity || 
                            item.qty || 
                            1;
                            
                        const itemPrice = 
                            parseFloat(item.price) || 
                            parseFloat(item.unitPrice) || 
                            0;
                            
                        const itemTotal = itemPrice * itemQuantity;
                        
                        const itemImage = 
                            item.imageURL || 
                            item.image || 
                            item.img || 
                            'https://via.placeholder.com/50?text=Product';
                        
                        itemsHtml += `
                            <div class="order-item">
                                <div class="item-image">
                                    <img src="${itemImage}" 
                                         alt="${itemName}"
                                         onerror="this.src='https://via.placeholder.com/50?text=Product'">
                                </div>
                                <div class="item-info">
                                    <p class="item-name">${itemName}</p>
                                    <p class="item-quantity">Quantity: ${itemQuantity}</p>
                                </div>
                                <div class="item-price">₹${formatPrice(itemTotal)}</div>
                            </div>
                        `;
                    });
                } else {
                    console.warn('No items found in order or items is not an array:', order.items);
                    itemsHtml = '<p style="text-align: center; padding: 15px; color: #718096;">No items found</p>';
                }
                
                // Customer address
                const addressHtml = order.deliveryAddress ? 
                    `<div class="customer-details">
                        <p><i class="fas fa-map-marker-alt"></i> ${formatAddress(order.deliveryAddress)}</p>
                        ${order.userPhone || order.user?.phone ? 
                        `<p><i class="fas fa-phone"></i> ${order.userPhone || order.user.phone}</p>` : ''}
                    </div>` : 
                    '<div class="customer-details">No delivery address provided</div>';
                
                // Build the complete HTML
                orderDetailsContent.innerHTML = `
                    <div class="order-card">
                        <div class="order-header">
                            <h3>
                                <i class="fas fa-hashtag"></i>
                                Order #${order.id?.substring(0, 8) || 'Unknown'}
                                <span class="status-badge ${statusClass}">
                                    ${statusText}
                                </span>
                            </h3>
                            <p><i class="far fa-calendar-alt"></i> ${formattedDate}</p>
                        </div>
                        <div class="order-content">
                            <!-- Customer Information -->
                            <div class="customer-info">
                                <div style="display: flex; align-items: center;">
                                    <div class="customer-avatar">
                                        ${customerInitial}
                                    </div>
                                    <div style="margin-left: 10px;">
                                        <h3 class="customer-name">${customerName}</h3>
                                        ${addressHtml}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Order Items -->
                            <h4 class="section-title">
                                <i class="fas fa-shopping-cart"></i>
                                Order Items
                            </h4>
                            <div class="order-items-list">
                                ${itemsHtml}
                            </div>
                            
                            <!-- Order Summary -->
                            <div class="order-summary">
                                <div class="summary-row">
                                    <div>Subtotal</div>
                                    <div>₹${formatPrice(subtotal)}</div>
                                </div>
                                <div class="summary-row">
                                    <div>Platform Fee (${platformFeePercent}%)</div>
                                    <div>-₹${formatPrice(platformFee)}</div>
                                </div>
                                <div class="summary-row">
                                    <div>Delivery Fee</div>
                                    <div>₹${formatPrice(deliveryFee)}</div>
                                </div>
                                <div class="summary-row total">
                                    <div>You Receive</div>
                                    <div>₹${formatPrice(vendorAmount)}</div>
                                </div>
                            </div>
                            
                            <!-- Delivery Options -->
                            <div class="delivery-options">
                                <h4 class="section-title">
                                    <i class="fas fa-truck"></i>
                                    Delivery Options
                                </h4>
                                <div class="option-buttons">
                                    <div class="option-btn locked" id="search-delivery">
                                        <i class="fas fa-search"></i>
                                        <span>Search for Delivery Guy</span>
                                    </div>
                                    <div class="option-btn" id="self-delivery">
                                        <i class="fas fa-walking"></i>
                                        <span>I'll Deliver Myself</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Status Checkpoints - hidden initially -->
                            <div class="status-checkpoints" id="status-checkpoints">
                                <h4 class="section-title">
                                    <i class="fas fa-clipboard-check"></i>
                                    Order Status Updates
                                </h4>
                                <div class="checkpoint" id="checkpoint-1" data-status="confirmed">
                                    <div class="checkpoint-header">
                                        <div class="checkpoint-title">Order Confirmed</div>
                                        <div class="checkpoint-actions">
                                            <button class="action-btn confirm" data-action="confirm" data-checkpoint="1">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="action-btn cancel" data-action="cancel" data-checkpoint="1">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="checkpoint-content">
                                        Confirm that you've received the order and will be processing it.
                                    </div>
                                </div>
                                
                                <div class="checkpoint" id="checkpoint-2" data-status="packed">
                                    <div class="checkpoint-header">
                                        <div class="checkpoint-title">Items Packed</div>
                                        <div class="checkpoint-actions">
                                            <button class="action-btn confirm" data-action="confirm" data-checkpoint="2">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="action-btn cancel" data-action="cancel" data-checkpoint="2">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="checkpoint-content">
                                        Mark when all items in the order have been packed and are ready for delivery.
                                    </div>
                                </div>
                                
                                <div class="checkpoint" id="checkpoint-3" data-status="out-for-delivery">
                                    <div class="checkpoint-header">
                                        <div class="checkpoint-title">Out for Delivery</div>
                                        <div class="checkpoint-actions">
                                            <button class="action-btn confirm" data-action="confirm" data-checkpoint="3">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="action-btn cancel" data-action="cancel" data-checkpoint="3">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="checkpoint-content">
                                        Mark when the order has left your store and is on the way to the customer.
                                    </div>
                                </div>
                                
                                <div class="checkpoint" id="checkpoint-4" data-status="delivered">
                                    <div class="checkpoint-header">
                                        <div class="checkpoint-title">Delivered</div>
                                        <div class="checkpoint-actions">
                                            <button class="action-btn confirm" data-action="confirm" data-checkpoint="4">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="action-btn cancel" data-action="cancel" data-checkpoint="4">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="checkpoint-content">
                                        Mark when the order has been successfully delivered to the customer.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Store order data for use in event handlers
                window.currentOrder = order;
                
                // Set up event listeners for delivery options
                document.getElementById('search-delivery').addEventListener('click', function() {
                    showToast('Coming Soon', 'This feature will be available soon!', 'info');
                });
                
                document.getElementById('self-delivery').addEventListener('click', function() {
                    this.classList.toggle('active');
                    const checkpoints = document.getElementById('status-checkpoints');
                    
                    if (this.classList.contains('active')) {
                        checkpoints.style.display = 'block';
                        
                        // Mark checkpoints as completed based on current status
                        updateCheckpointsBasedOnStatus(status);
                    } else {
                        checkpoints.style.display = 'none';
                    }
                });
                
                // Set up event listeners for checkpoint actions
                document.querySelectorAll('.action-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        const checkpointNum = this.getAttribute('data-checkpoint');
                        const checkpoint = document.getElementById(`checkpoint-${checkpointNum}`);
                        const status = checkpoint.getAttribute('data-status');
                        
                        if (action === 'confirm') {
                            updateOrderStatus(status);
                        } else {
                            // Cancel action - just show a message
                            showToast('Action Cancelled', 'Status update cancelled.', 'info');
                        }
                    });
                });
                
                console.log('Order details displayed successfully');
                
            } catch (error) {
                console.error('Error displaying order details:', error);
                showError('Display Error', 'An error occurred while displaying the order details.', error);
            }
        }
        
        // Update checkpoints based on current status
        function updateCheckpointsBasedOnStatus(currentStatus) {
            currentStatus = currentStatus.toLowerCase();
            
            // Define status progression
            const statuses = ['confirmed', 'packed', 'out-for-delivery', 'delivered'];
            
            // Find current status index
            let currentIndex = statuses.indexOf(currentStatus);
            if (currentIndex === -1) {
                // If status not found, default to none completed
                currentIndex = -1;
            }
            
            // Mark all checkpoints up to current status as completed
            for (let i = 0; i <= currentIndex; i++) {
                const checkpoint = document.getElementById(`checkpoint-${i+1}`);
                if (checkpoint) {
                    checkpoint.classList.add('completed');
                    
                    // Update UI to show checkmark
                    const title = checkpoint.querySelector('.checkpoint-title');
                    if (!title.querySelector('.fas')) {
                        title.innerHTML = `<i class="fas fa-check-circle"></i> ${title.textContent}`;
                    }
                }
            }
        }
        
        // Update order status in database
        function updateOrderStatus(newStatus) {
            if (!window.currentOrder || !window.currentOrder.id) {
                showToast('Error', 'Order data not found.', 'error');
                return;
            }
            
            const orderId = window.currentOrder.id;
            const userId = window.currentOrder.userId || window.currentOrder.customerId || window.currentOrder.user?.id;
            
            // Show loading state
            const checkpoint = document.querySelector(`[data-status="${newStatus}"]`);
            if (checkpoint) {
                checkpoint.classList.add('updating');
            }
            
            showToast('Processing', 'Updating order status...', 'info');
            
            // Create batch updates object
            const updates = {};
            
            // Update in the main order collections
            updates[`orders/${orderId}/status`] = newStatus;
            updates[`allOrders/${orderId}/status`] = newStatus;
            
            // Also update in user's orders
            if (userId) {
                // For each possible location where user orders might be stored
                updates[`userOrders/${userId}/${orderId}/status`] = newStatus;
                updates[`users/${userId}/orders/${orderId}/status`] = newStatus;
            }
            
            // Update timestamp
            const timestamp = Date.now();
            updates[`orders/${orderId}/lastUpdated`] = timestamp;
            updates[`allOrders/${orderId}/lastUpdated`] = timestamp;
            
            // Update timestamp in user orders too
            if (userId) {
                updates[`userOrders/${userId}/${orderId}/lastUpdated`] = timestamp;
                updates[`users/${userId}/orders/${orderId}/lastUpdated`] = timestamp;
            }
            
            // Create status update object
            const statusUpdate = {
                status: newStatus,
                timestamp: timestamp,
                updatedBy: 'vendor'
            };
            
            console.log(`Updating order ${orderId} status to ${newStatus}`);
            if (userId) console.log(`Updating for user ${userId}`);
            
            // First check if the order has a statusHistory array
            firebase.database().ref(`orders/${orderId}/statusHistory`).once('value')
                .then(snapshot => {
                    let statusHistory = [];
                    
                    if (snapshot.exists()) {
                        statusHistory = snapshot.val();
                        // Make sure it's an array
                        if (!Array.isArray(statusHistory)) {
                            statusHistory = [];
                        }
                    }
                    
                    // Add the new status update
                    statusHistory.push(statusUpdate);
                    
                    // Update the status history in all locations
                    updates[`orders/${orderId}/statusHistory`] = statusHistory;
                    updates[`allOrders/${orderId}/statusHistory`] = statusHistory;
                    
                    if (userId) {
                        updates[`userOrders/${userId}/${orderId}/statusHistory`] = statusHistory;
                        updates[`users/${userId}/orders/${orderId}/statusHistory`] = statusHistory; 
                    }
                    
                    console.log('Applying database updates...');
                    return firebase.database().ref().update(updates);
                })
                .then(() => {
                    console.log('Order status updated successfully');
                    
                    if (checkpoint) {
                        checkpoint.classList.remove('updating');
                        checkpoint.classList.add('completed');
                        
                        // Update UI to show checkmark
                        const title = checkpoint.querySelector('.checkpoint-title');
                        if (!title.querySelector('.fas')) {
                            title.innerHTML = `<i class="fas fa-check-circle"></i> ${title.textContent}`;
                        }
                    }
                    
                    // Update current order object
                    window.currentOrder.status = newStatus;
                    
                    // Update localStorage if needed
                    localStorage.setItem('selectedOrder', JSON.stringify(window.currentOrder));
                    
                    // Display success message
                    showToast('Status Updated', `Order status updated to ${getStatusText(newStatus)}`, 'success');
                    
                    // Update header status badge
                    const statusBadge = document.querySelector('.status-badge');
                    if (statusBadge) {
                        statusBadge.className = `status-badge ${getStatusClass(newStatus)}`;
                        statusBadge.textContent = getStatusText(newStatus);
                    }
                })
                .catch(error => {
                    console.error('Error updating order status:', error);
                    if (checkpoint) {
                        checkpoint.classList.remove('updating');
                    }
                    showToast('Error', `Failed to update status: ${error.message}`, 'error');
                });
        }
        
        // Show toast notification
        function showToast(title, message, type = 'info') {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                document.body.removeChild(existingToast);
            }
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Set icon based on type
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <div>
                    <strong>${title}</strong>
                    ${message ? `<div>${message}</div>` : ''}
                </div>
            `;
            
            // Add to body
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // Calculate subtotal from items
        function calculateSubtotal(items) {
            return items.reduce((total, item) => {
                const price = parseFloat(item.price) || 0;
                const quantity = parseInt(item.quantity) || 1;
                return total + (price * quantity);
            }, 0);
        }
        
        // Format address
        function formatAddress(address) {
            if (typeof address === 'string') return address;
            if (!address) return 'No address provided';
            
            const parts = [];
            if (address.street) parts.push(address.street);
            if (address.city) parts.push(address.city);
            if (address.state) parts.push(address.state);
            if (address.pincode) parts.push(address.pincode);
            
            return parts.join(', ') || 'No address provided';
        }
        
        // Format price with commas for thousands
        function formatPrice(price) {
            const numPrice = parseFloat(price);
            if (isNaN(numPrice)) return '0.00';
            
            return numPrice.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Get status class for badge styling
        function getStatusClass(status) {
            status = String(status).toLowerCase();
            
            switch (status) {
                case 'pending':
                    return 'status-pending';
                case 'confirmed':
                    return 'status-confirmed';
                case 'packed':
                    return 'status-packed';
                case 'out-for-delivery':
                case 'out for delivery':
                    return 'status-shipping';
                case 'delivered':
                    return 'status-delivered';
                case 'cancelled':
                case 'canceled':
                    return 'status-cancelled';
                default:
                    return 'status-pending';
            }
        }
        
        // Get formatted status text
        function getStatusText(status) {
            status = String(status).toLowerCase();
            
            switch (status) {
                case 'pending':
                    return 'Pending';
                case 'confirmed':
                    return 'Confirmed';
                case 'packed':
                    return 'Packed';
                case 'out-for-delivery':
                case 'out for delivery':
                    return 'Out for Delivery';
                case 'delivered':
                    return 'Delivered';
                case 'cancelled':
                case 'canceled':
                    return 'Cancelled';
                default:
                    return 'Pending';
            }
        }
        
        // Format date to readable string
        function formatDate(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
                return 'Invalid Date';
            }
            
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            return date.toLocaleDateString('en-IN', options);
        }
    </script>
</body>
</html> 