<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Dashboard - Grozily</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Remove blue tap highlights */
        }

        body {
            background-color: #F5F7FA;
            color: #2D3748;
            min-height: 100vh;
        }

        /* Mobile-first App Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background-color: #805AD5;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .vendor-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .vendor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #6B46C1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .vendor-details {
            line-height: 1.3;
        }

        .store-name {
            font-weight: bold;
            font-size: 16px;
        }

        .vendor-name {
            font-size: 12px;
            opacity: 0.8;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .header-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .header-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }



        /* Stats Section */
        .stats-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: #805AD5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-card {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card.large {
            grid-column: span 2;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
        }

        .stat-icon.purple {
            background-color: #805AD5;
        }

        .stat-icon.blue {
            background-color: #4299E1;
        }

        .stat-icon.green {
            background-color: #48BB78;
        }

        .stat-icon.orange {
            background-color: #ED8936;
        }

        .stat-info {
            flex: 1;
        }

        .stat-title {
            color: #718096;
            font-size: 14px;
            margin-top: 10px;
        }

        .stat-value {
            font-size: 22px;
            font-weight: bold;
            margin-top: 5px;
        }

        .stat-card.large .stat-title {
            margin-top: 0;
        }

        /* Quick Actions */
        .quick-actions {
            margin-bottom: 25px;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .action-card {
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            cursor: pointer;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .action-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            color: white;
            font-size: 20px;
        }

        .action-title {
            font-size: 14px;
            font-weight: 500;
        }

        /* Recent Activity */
        .recent-activity {
            margin-bottom: 25px;
        }

        .activity-list {
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .activity-item {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #EDF2F7;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .activity-details {
            flex: 1;
        }

        .activity-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: #718096;
        }

        .activity-list .empty-activity {
            text-align: center;
            padding: 30px 20px;
            color: #A0AEC0;
        }

        .activity-list .empty-activity i {
            font-size: 40px;
            margin-bottom: 15px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            display: flex;
            background-color: white;
            border-top: 1px solid #EDF2F7;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            color: #718096;
            text-decoration: none;
            font-size: 12px;
            transition: color 0.2s;
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .nav-item.active {
            color: #805AD5;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #805AD5;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(128, 90, 213, 0.4);
            cursor: pointer;
            z-index: 90;
            transition: all 0.2s;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(128, 90, 213, 0.5);
        }

        /* Loader */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(128, 90, 213, 0.2);
            border-radius: 50%;
            border-top-color: #805AD5;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .actions-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Profile Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #EDF2F7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1;
            border-radius: 15px 15px 0 0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2D3748;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #718096;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background-color: #F7FAFC;
            color: #E53E3E;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4A5568;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            background-color: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #805AD5;
            box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.2);
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .form-row .form-group {
            flex: 1;
            min-width: 120px; /* Minimum width to prevent too narrow fields */
        }

        .days-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .day-label {
            padding: 8px 12px;
            background-color: #EDF2F7;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .day-label.selected {
            background-color: #805AD5;
            color: white;
        }

        .day-checkbox {
            display: none;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #EDF2F7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            bottom: 0;
            background-color: white;
            border-radius: 0 0 15px 15px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 10px;
        }

        .modal-footer > div {
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Allow button wrapping */
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap; /* Prevent button text from wrapping */
        }

        .btn-primary {
            background-color: #805AD5;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background-color: #6B46C1;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: white;
            color: #4A5568;
            border: 1px solid #E2E8F0;
        }

        .btn-secondary:hover {
            background-color: #F7FAFC;
        }

        .btn-danger {
            background-color: #F56565;
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background-color: #E53E3E;
        }

        /* Responsive adjustments for modal */
        @media (max-width: 480px) {
            .modal-footer {
                flex-direction: column-reverse;
                align-items: stretch;
            }
            
            .modal-footer > div {
                justify-content: center;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }
        }

        /* Location picker styles */
        .location-section {
            margin-bottom: 20px;
        }

        .location-picker {
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            padding: 15px;
            background-color: #F8FAFC;
            margin-top: 10px;
        }

        .location-search {
            display: flex;
            margin-bottom: 15px;
            position: relative;
            z-index: 10;
        }

        .location-search input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px 0 0 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .location-search input:focus {
            border-color: #805AD5;
        }

        .location-search button {
            padding: 12px 15px;
            background-color: #805AD5;
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .location-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            border: 1px solid #e0e0e0;
            border-top: none;
            margin-top: -1px;
            opacity: 0;
            transform: translateY(-5px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .location-suggestions.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            line-height: 1.4;
            transition: background-color 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #000;
        }

        .suggestion-item:hover {
            background-color: #f9f5ff;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .current-location-btn {
            margin-bottom: 15px;
        }

        .current-location-btn button {
            width: 100%;
            padding: 12px;
            background-color: #4A5568;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .current-location-btn button:hover {
            background-color: #2D3748;
        }

        .location-map {
            height: 250px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            width: 100%;
            position: relative;
            z-index: 1;
            opacity: 1;
            transition: height 0.3s ease;
        }

        .selected-location {
            margin-top: 15px;
        }

        .selected-location p {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .selected-location h4 {
            font-size: 15px;
            color: #333;
            font-weight: 500;
        }

        /* Leaflet map controls */
        .location-map .leaflet-control-container {
            z-index: 1000;
        }

        .location-map .leaflet-top, 
        .location-map .leaflet-bottom {
            z-index: 1000;
        }

        /* Product Requests Section */
        .product-requests {
            margin-bottom: 25px;
        }

        /* Update button styles to be more professional */
        .clear-requests-btn, .reset-requests-btn {
            background: none;
            color: #718096;
            border: 1px solid #E2E8F0;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .clear-requests-btn {
            color: #E53E3E;
        }
        
        .reset-requests-btn {
            color: #4299E1;
        }

        .clear-requests-btn:hover {
            background-color: #FFF5F5;
            color: #C53030;
        }
        
        .reset-requests-btn:hover {
            background-color: #EBF8FF;
            color: #3182CE;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .badge {
            display: inline-block;
            background-color: #805AD5;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 8px;
        }

        .product-requests-list {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .request-card {
            padding: 15px;
            border-bottom: 1px solid #EDF2F7;
            transition: background-color 0.2s;
        }

        .request-card:last-child {
            border-bottom: none;
        }

        .request-card:hover {
            background-color: #F7FAFC;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .request-title {
            font-weight: 600;
            font-size: 16px;
            color: #2D3748;
        }

        .request-time {
            font-size: 12px;
            color: #718096;
        }

        .request-user {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #4A5568;
        }

        .request-user i {
            color: #805AD5;
        }

        .request-details {
            background-color: #F7FAFC;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .request-details p {
            margin-bottom: 5px;
        }

        .request-details p:last-child {
            margin-bottom: 0;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        .request-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-left: auto;
        }

        .request-status.pending {
            background-color: #FFF5F5;
            color: #E53E3E;
        }

        .request-status.approved {
            background-color: #F0FFF4;
            color: #38A169;
        }

        .price-input-wrapper {
            display: flex;
            align-items: center;
            margin: 10px 0;
            background-color: white;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            overflow: hidden;
        }

        .price-input-wrapper span {
            padding: 0 10px;
            background-color: #EDF2F7;
            color: #4A5568;
            font-weight: 500;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .price-input {
            flex: 1;
            border: none;
            padding: 8px 12px;
            font-size: 14px;
            outline: none;
        }

        .empty-requests {
            text-align: center;
            padding: 40px 20px;
            color: #A0AEC0;
        }

        .empty-requests i {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
        }
        
        /* Processing and warning styles */
        .warning-text {
            color: #e53e3e;
            font-weight: 500;
        }
        
        .request-card.processing {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .request-card.processing::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 10;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .debug-note {
            color: #718096;
            font-style: italic;
            margin-top: 5px;
        }

        /* Improved Toast notification for in-page messages */
        .vendor-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 300px;
            max-width: 90%;
            background-color: #2D3748;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            opacity: 0;
            transform: translateX(50px);
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }
        
        .vendor-toast.show {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }
        
        .vendor-toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .vendor-toast-content {
            flex: 1;
        }
        
        .vendor-toast-title {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
        }
        
        .vendor-toast-message {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .vendor-toast-close {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 5px;
            margin: -5px;
            transition: color 0.2s;
        }
        
        .vendor-toast-close:hover {
            color: white;
        }
        
        .vendor-toast.success {
            background-color: #48BB78;
        }
        
        .vendor-toast.error {
            background-color: #F56565;
        }
        
        .vendor-toast.info {
            background-color: #4299E1;
        }

        /* Confirmation dialog styles */
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .confirmation-dialog.show {
            opacity: 1;
            visibility: visible;
        }

        .confirmation-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .confirmation-header {
            padding: 15px;
            background-color: #F7FAFC;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #EDF2F7;
        }

        .confirmation-icon {
            color: #E53E3E;
            font-size: 20px;
        }

        .confirmation-title {
            font-size: 16px;
            font-weight: 600;
        }

        .confirmation-body {
            padding: 15px;
            color: #4A5568;
            font-size: 14px;
        }

        .confirmation-footer {
            padding: 10px 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid #EDF2F7;
        }

        .btn-cancel, .btn-confirm {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-cancel {
            background-color: #EDF2F7;
            color: #4A5568;
        }

        .btn-cancel:hover {
            background-color: #E2E8F0;
        }

        .btn-confirm {
            background-color: #E53E3E;
            color: white;
        }

        .btn-confirm:hover {
            background-color: #C53030;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <div class="app-header">
            <div class="vendor-info">
                <div class="vendor-avatar" id="vendor-initial">V</div>
                <div class="vendor-details">
                    <div class="store-name" id="store-name">Loading...</div>
                    <div class="vendor-name" id="vendor-name">Loading...</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="notifications-btn">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="header-btn" id="profile-btn">
                    <i class="fas fa-user"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Stats Section -->
            <div class="stats-section">
                <h2 class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Store Statistics
                </h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-title">Products</div>
                        <div class="stat-value" id="total-products">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-title">Orders</div>
                        <div class="stat-value" id="total-orders">0</div>
                    </div>
                    <div class="stat-card large">
                        <div class="stat-icon green">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">Total Revenue</div>
                            <div class="stat-value" id="total-revenue">₹0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h2 class="section-title">
                    <i class="fas fa-bolt"></i>
                    Quick Actions
                </h2>
                <div class="actions-grid">
                    <div class="action-card" id="action-add-product">
                        <div class="action-icon" style="background-color: #805AD5;">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="action-title">Add Product</div>
                    </div>
                    <div class="action-card" id="action-orders">
                        <div class="action-icon" style="background-color: #4299E1;">
                            <i class="fas fa-list-alt"></i>
                        </div>
                        <div class="action-title">View Orders</div>
                    </div>
                    <div class="action-card" id="action-profile">
                        <div class="action-icon" style="background-color: #48BB78;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="action-title">My Profile</div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="recent-activity">
                <h2 class="section-title">
                    <i class="fas fa-history"></i>
                    Recent Activity
                </h2>
                <div class="activity-list" id="activity-list">
                    <div class="activity-item">
                        <div class="activity-icon" style="background-color: #805AD5;">
                            <i class="fas fa-sign-in-alt"></i>
                        </div>
                        <div class="activity-details">
                            <div class="activity-title">Account Login</div>
                            <div class="activity-time" id="login-time">Just now</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Requests -->
            <div class="product-requests">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-list"></i>
                    Product Requests
                    <span class="badge" id="requests-count">0</span>
                    <div style="display: flex; gap: 8px; margin-left: auto;">
                        <button id="reset-requests-btn" class="reset-requests-btn">
                            <i class="fas fa-redo-alt"></i> Reset
                        </button>
                        <button id="clear-all-requests" class="clear-requests-btn">
                            <i class="fas fa-trash-alt"></i> Clear All
                        </button>
                    </div>
                </h2>
                <div class="product-requests-list" id="product-requests-list">
                    <div class="empty-requests">
                        <i class="fas fa-inbox"></i>
                        <p>No product requests yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Action Button -->
        <div class="fab" id="add-product-fab">
            <i class="fas fa-plus"></i>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <a href="#" class="nav-item active">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="products.html" class="nav-item">
                <i class="fas fa-box"></i>
                <span>Products</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-shopping-cart"></i>
                <span>Orders</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Vendor Profile</h3>
                <button class="modal-close" id="profile-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="profile-form">
                    <div class="form-group">
                        <label for="owner-name">Owner Name</label>
                        <input type="text" id="owner-name" required>
                    </div>
                    <div class="form-group">
                        <label for="shop-name">Shop Name</label>
                        <input type="text" id="shop-name" required>
                    </div>
                    <div class="form-group">
                        <label for="shop-category">Shop Category</label>
                        <select id="shop-category" required>
                            <option value="">Select a category</option>
                            <option value="Grocery">Grocery</option>
                            <option value="Fruits & Vegetables">Fruits & Vegetables</option>
                            <option value="Meat & Fish">Meat & Fish</option>
                            <option value="Bakery">Bakery</option>
                            <option value="Dairy & Eggs">Dairy & Eggs</option>
                            <option value="Snacks">Snacks</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Personal Care">Personal Care</option>
                            <option value="Household">Household</option>
                            <option value="Pharmacy">Pharmacy</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <!-- Shop Location Section -->
                    <div class="form-group location-section">
                        <label for="location">Shop Location</label>
                        
                        <div class="location-picker">
                            <div class="location-search">
                                <input type="text" id="location-search" placeholder="Search for an area or address">
                                <button type="button" id="location-search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            
                            <div class="location-suggestions" id="location-suggestions"></div>
                            
                            <div class="current-location-btn">
                                <button type="button" id="use-current-location">
                                    <i class="fas fa-location-arrow"></i>
                                    Use My Current Location
                                </button>
                            </div>
                            
                            <div id="location-map" class="location-map"></div>
                            
                            <div class="selected-location">
                                <p>Selected Location:</p>
                                <h4 id="selected-location-text">No location selected</h4>
                                
                                <input type="hidden" id="location-lat">
                                <input type="hidden" id="location-lng">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="location">Address</label>
                            <input type="text" id="location" required>
                        </div>
                        <div class="form-group">
                            <label for="pin-code">PIN Code</label>
                            <input type="text" id="pin-code" pattern="[0-9]{6}" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="opening-time">Opening Time</label>
                            <input type="time" id="opening-time" required>
                        </div>
                        <div class="form-group">
                            <label for="closing-time">Closing Time</label>
                            <input type="time" id="closing-time" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Open Days</label>
                        <div class="days-selection">
                            <input type="checkbox" id="monday" class="day-checkbox">
                            <label for="monday" class="day-label">Monday</label>
                            
                            <input type="checkbox" id="tuesday" class="day-checkbox">
                            <label for="tuesday" class="day-label">Tuesday</label>
                            
                            <input type="checkbox" id="wednesday" class="day-checkbox">
                            <label for="wednesday" class="day-label">Wednesday</label>
                            
                            <input type="checkbox" id="thursday" class="day-checkbox">
                            <label for="thursday" class="day-label">Thursday</label>
                            
                            <input type="checkbox" id="friday" class="day-checkbox">
                            <label for="friday" class="day-label">Friday</label>
                            
                            <input type="checkbox" id="saturday" class="day-checkbox">
                            <label for="saturday" class="day-label">Saturday</label>
                            
                            <input type="checkbox" id="sunday" class="day-checkbox">
                            <label for="sunday" class="day-label">Sunday</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="left-buttons">
                    <button class="btn btn-danger" id="delete-account-btn">
                        <i class="fas fa-trash"></i>
                        Delete Account
                    </button>
                </div>
                <div class="right-buttons">
                    <button class="btn btn-secondary" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                    <button class="btn btn-primary" id="save-profile-btn">
                        <i class="fas fa-save"></i>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
    </div>

    <!-- Toast notification element -->
    <div id="vendor-toast" class="vendor-toast">
        <div class="vendor-toast-icon">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="vendor-toast-content">
            <div class="vendor-toast-title">Notification</div>
            <div class="vendor-toast-message">This is a notification message.</div>
        </div>
        <div class="vendor-toast-close" id="toast-close">
            <i class="fas fa-times"></i>
        </div>
    </div>

    <!-- Confirmation dialog -->
    <div id="confirmation-dialog" class="confirmation-dialog">
        <div class="confirmation-content">
            <div class="confirmation-header">
                <div class="confirmation-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="confirmation-title">Confirm Action</div>
            </div>
            <div class="confirmation-body">
                Are you sure you want to clear all product requests? This will only remove them from your view.
            </div>
            <div class="confirmation-footer">
                <button id="cancel-clear" class="btn-cancel">Cancel</button>
                <button id="confirm-clear" class="btn-confirm">Clear All</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCtbwkusKvCEYNCHUytaF4tUISNywsADiM",
            authDomain: "grozily2.firebaseapp.com",
            databaseURL: "https://grozily2-default-rtdb.firebaseio.com",
            projectId: "grozily2",
            storageBucket: "grozily2.firebasestorage.app",
            messagingSenderId: "665300145710",
            appId: "1:665300145710:web:4f8d866e07fc902b1131bf",
            measurementId: "G-83S7ZWXEB9"
        };
        
        // Initialize Firebase OPTIONAL - if you've initialized Firebase elsewhere
        firebase.initializeApp(firebaseConfig);
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM content loaded, initializing page...');
            
            // Set up the Clear All button
            const clearAllBtn = document.getElementById('clear-all-requests');
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', function() {
                    clearAllRequests();
                });
                console.log('Clear All button listener added');
            } else {
                console.error('Clear All button not found in DOM');
            }
            
            // Set up the Reset button
            const resetBtn = document.getElementById('reset-requests-btn');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    resetRequestsView();
                });
                console.log('Reset button listener added');
            } else {
                console.error('Reset button not found in DOM');
            }
            
            // Check login status
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    console.log('User is logged in:', user.uid);
                    document.getElementById('loader').style.display = 'none';
                    
                    // Load data
                    loadVendorData();
                    loadProductRequests();
                    loadRecentOrders();
                    getRevenueData();
                    
                    // Add event listener for clear all requests button
                    document.getElementById('clear-all-requests').addEventListener('click', clearAllRequests);
                    
                    // Set up event listeners
                    document.getElementById('profile-btn').addEventListener('click', function() {
                        document.getElementById('profile-modal').classList.add('show');
                    });
                } else {
                    // User is not logged in, redirect to login page
                    window.location.href = 'vendor-login.html';
                }
            });
        });

        // DOM Elements
        const loader = document.getElementById('loader');
        const vendorInitial = document.getElementById('vendor-initial');
        const storeName = document.getElementById('store-name');
        const vendorName = document.getElementById('vendor-name');
        const totalProducts = document.getElementById('total-products');
        const totalOrders = document.getElementById('total-orders');
        const totalRevenue = document.getElementById('total-revenue');
        const activityList = document.getElementById('activity-list');
        const loginTime = document.getElementById('login-time');
        const logoutBtn = document.getElementById('logout-btn');
        
        // Profile Modal Elements
        const profileBtn = document.getElementById('profile-btn');
        const profileModal = document.getElementById('profile-modal');
        const profileModalClose = document.getElementById('profile-modal-close');
        const profileForm = document.getElementById('profile-form');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const dayLabels = document.querySelectorAll('.day-label');

        // Current vendor data
        let currentUser = null;
        let currentVendorData = null;
        
        // Location picker variables
        let locationPickerMap = null;
        let locationMarker = null;
        let selectedLocation = null;
        let debounceTimeout = null;

        // Show/Hide Loader
        function showLoader() {
            loader.style.display = 'flex';
        }

        function hideLoader() {
            loader.style.display = 'none';
        }

        // Format currency
        function formatCurrency(amount) {
            return '₹' + parseFloat(amount).toLocaleString('en-IN');
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Get time ago
        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + ' years ago';
            
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + ' months ago';
            
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + ' days ago';
            
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + ' hours ago';
            
            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + ' minutes ago';
            
            if(seconds < 10) return 'just now';
            
            return Math.floor(seconds) + ' seconds ago';
        }

        // Check authentication state
        showLoader();
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                // Not logged in, redirect to login
                window.location.href = 'vendor-login.html';
                return;
            }

            currentUser = user;

            // Verify if the user is a vendor
            firebase.database().ref(`vendors/${user.uid}`).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        // Not a vendor, sign out and redirect
                        firebase.auth().signOut();
                        window.location.href = 'vendor-login.html';
                        return;
                    }

                    // Load vendor data
                    const vendor = snapshot.val();
                    currentVendorData = vendor;
                    
                    storeName.textContent = vendor.storeName || 'My Store';
                    vendorName.textContent = vendor.name || 'Vendor';
                    
                    // Set vendor initial
                    if (vendor.name) {
                        vendorInitial.textContent = vendor.name.charAt(0).toUpperCase();
                    }
                    
                    // Format time for activity log
                    const lastLoginTime = new Date(user.metadata.lastSignInTime);
                    loginTime.textContent = timeAgo(lastLoginTime);
                    
                    // Fill profile form
                    fillProfileForm(vendor);

                    // Load dashboard data
                    loadDashboardData(user.uid);
                    
                    // Load product requests
                    loadProductRequests();
                    
                    // Cleanup any buggy products that were added to store details
                    cleanupBuggyProducts();
                    
                    // Auto-fix cart issues
                    autoFixCartIssues();
                    
                    hideLoader();
                })
                .catch((error) => {
                    console.error('Error loading vendor data:', error);
                    alert('Error loading vendor data: ' + error.message);
                    hideLoader();
                });
        });

        // Fill profile form with vendor data
        function fillProfileForm(vendor) {
            document.getElementById('owner-name').value = vendor.name || '';
            document.getElementById('shop-name').value = vendor.storeName || '';
            document.getElementById('location').value = vendor.location || '';
            document.getElementById('pin-code').value = vendor.pinCode || '';
            document.getElementById('shop-category').value = vendor.shopCategory || '';
            document.getElementById('opening-time').value = vendor.openingTime || '09:00';
            document.getElementById('closing-time').value = vendor.closingTime || '18:00';
            
            // Set location data if available
            if (vendor.locationLat && vendor.locationLng) {
                document.getElementById('location-lat').value = vendor.locationLat;
                document.getElementById('location-lng').value = vendor.locationLng;
                document.getElementById('selected-location-text').textContent = vendor.locationDisplay || 'Location selected';
            } else {
                document.getElementById('location-lat').value = '';
                document.getElementById('location-lng').value = '';
                document.getElementById('selected-location-text').textContent = 'No location selected';
            }
            
            // Handle open days
            const openDays = vendor.openDays || ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            dayLabels.forEach(label => {
                const day = label.textContent;
                const checkbox = document.getElementById(day.toLowerCase());
                if (checkbox && openDays.includes(day)) {
                    checkbox.checked = true;
                    label.classList.add('selected');
                } else {
                    checkbox.checked = false;
                    label.classList.remove('selected');
                }
            });
        }

        // Load dashboard data
        function loadDashboardData(vendorId) {
            // Get products count
            firebase.database().ref('products').orderByChild('vendorId').equalTo(vendorId).once('value')
                .then((snapshot) => {
                    const productsCount = snapshot.exists() ? snapshot.numChildren() : 0;
                    totalProducts.textContent = productsCount;
                    
                    // After getting products, get orders
                    return firebase.database().ref('orders').orderByChild('vendorId').equalTo(vendorId).once('value');
                })
                .then((ordersSnapshot) => {
                    // Calculate orders count and total revenue
                    let ordersCount = 0;
                    let revenue = 0;
                    
                    if (ordersSnapshot.exists()) {
                        ordersSnapshot.forEach((orderSnapshot) => {
                            const order = orderSnapshot.val();
                            ordersCount++;
                            if (order.totalAmount) {
                                revenue += parseFloat(order.totalAmount);
                            }
                        });
                    }
                    
                    totalOrders.textContent = ordersCount;
                    totalRevenue.textContent = formatCurrency(revenue);
                    
                    // Get recent activities
                    loadRecentActivities(vendorId);
                })
                .catch((error) => {
                    console.error('Error loading dashboard data:', error);
                });
        }

        // Load recent activities
        function loadRecentActivities(vendorId) {
            // This is a placeholder for actual activity data
            // In a real app, you would fetch activities from the database
            
            // For now, we'll just show the login activity that we already have
        }

        // Handle profile button click
        profileBtn.addEventListener('click', () => {
            profileModal.classList.add('show');
            
            // Initialize location picker when modal is opened
            setTimeout(() => {
                initLocationPicker();
            }, 300);
        });

        // Close profile modal
        profileModalClose.addEventListener('click', () => {
            profileModal.classList.remove('show');
        });

        // Close modal when clicking outside
        profileModal.addEventListener('click', (e) => {
            if (e.target === profileModal) {
                profileModal.classList.remove('show');
            }
        });

        // Toggle day selection
        dayLabels.forEach(label => {
            label.addEventListener('click', () => {
                const checkbox = document.getElementById(label.getAttribute('for'));
                checkbox.checked = !checkbox.checked;
                if (checkbox.checked) {
                    label.classList.add('selected');
                } else {
                    label.classList.remove('selected');
                }
            });
        });

        // Save profile changes
        saveProfileBtn.addEventListener('click', () => {
            if (!profileForm.checkValidity()) {
                // Trigger form validation
                const submitEvent = new Event('submit', { cancelable: true });
                profileForm.dispatchEvent(submitEvent);
                return;
            }
            
            showLoader();
            
            // Get location data from hidden inputs
            const locationLat = document.getElementById('location-lat').value;
            const locationLng = document.getElementById('location-lng').value;
            const locationDisplay = document.getElementById('selected-location-text').textContent;
            
            // Get updated profile data
            const updatedProfile = {
                name: document.getElementById('owner-name').value,
                storeName: document.getElementById('shop-name').value,
                location: document.getElementById('location').value,
                pinCode: document.getElementById('pin-code').value,
                shopCategory: document.getElementById('shop-category').value,
                openingTime: document.getElementById('opening-time').value,
                closingTime: document.getElementById('closing-time').value,
                openDays: getSelectedDays(),
                updatedAt: new Date().toISOString()
            };
            
            // Include location coordinates if available
            if (locationLat && locationLng) {
                updatedProfile.locationLat = locationLat;
                updatedProfile.locationLng = locationLng;
                updatedProfile.locationDisplay = locationDisplay;
            }
            
            // Update in Firebase
            firebase.database().ref(`vendors/${currentUser.uid}`).update(updatedProfile)
                .then(() => {
                    // Update current data
                    currentVendorData = { ...currentVendorData, ...updatedProfile };
                    
                    // Update UI
                    storeName.textContent = updatedProfile.storeName;
                    vendorName.textContent = updatedProfile.name;
                    vendorInitial.textContent = updatedProfile.name.charAt(0).toUpperCase();
                    
                    // Show success message and close modal
                    alert('Profile updated successfully!');
                    profileModal.classList.remove('show');
                    hideLoader();
                })
                .catch((error) => {
                    console.error('Error updating profile:', error);
                    alert('Error updating profile: ' + error.message);
                    hideLoader();
                });
        });

        // Get selected days
        function getSelectedDays() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            return days.filter(day => document.getElementById(day).checked)
                .map(day => day.charAt(0).toUpperCase() + day.slice(1));
        }

        // Handle delete account button
        deleteAccountBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                showLoader();
                
                // Delete vendor data first
                firebase.database().ref(`vendors/${currentUser.uid}`).remove()
                    .then(() => {
                        // Then delete auth account
                        return currentUser.delete();
                    })
                    .then(() => {
                        // Redirect to login page
                        window.location.href = 'vendor-login.html';
                    })
                    .catch((error) => {
                        console.error('Error deleting account:', error);
                        alert('Error deleting account: ' + error.message);
                        hideLoader();
                    });
            }
        });

        // Handle logout
        logoutBtn.addEventListener('click', () => {
            showLoader();
            firebase.auth().signOut()
                .then(() => {
                    window.location.href = 'vendor-login.html';
                })
                .catch((error) => {
                    console.error('Error signing out:', error);
                    hideLoader();
                    alert('Error signing out: ' + error.message);
                });
        });

        // Action buttons
        document.getElementById('add-product-fab').addEventListener('click', () => {
            window.location.href = 'add-product.html';
        });

        document.getElementById('action-add-product').addEventListener('click', () => {
            window.location.href = 'add-product.html';
        });

        document.getElementById('action-orders').addEventListener('click', () => {
            alert('Orders page coming soon!');
        });

        document.getElementById('action-profile').addEventListener('click', () => {
            alert('Profile page coming soon!');
        });

        document.getElementById('notifications-btn').addEventListener('click', () => {
            alert('Notifications coming soon!');
        });

        // Bottom nav
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                if (!this.classList.contains('active') && !this.getAttribute('href').includes('products.html')) {
                    e.preventDefault();
                    alert('This section will be available soon!');
                }
            });
        });

        // Initialize location picker
        function initLocationPicker() {
            // Initialize map only when modal is shown (for proper sizing)
            const locationMapDiv = document.getElementById('location-map');
            
            if (!locationPickerMap) {
                // Create map with a small delay to ensure container is visible
                setTimeout(() => {
                    try {
                        // Create map
                        locationPickerMap = L.map('location-map').setView([28.6139, 77.2090], 13); // Default to Delhi
                        
                        // Add tile layer
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap contributors'
                        }).addTo(locationPickerMap);
                        
                        // Force a resize after map creation
                        locationPickerMap.invalidateSize(true);
                        
                        // If we have stored coordinates, use them
                        if (currentVendorData && currentVendorData.locationLat && currentVendorData.locationLng) {
                            const lat = parseFloat(currentVendorData.locationLat);
                            const lng = parseFloat(currentVendorData.locationLng);
                            
                            if (!isNaN(lat) && !isNaN(lng)) {
                                locationPickerMap.setView([lat, lng], 15);
                                
                                // Add marker
                                locationMarker = L.marker([lat, lng], {
                                    draggable: true
                                }).addTo(locationPickerMap);
                                
                                // Update location info when marker is dragged
                                locationMarker.on('dragend', function(e) {
                                    updateSelectedLocation(e.target.getLatLng());
                                });
                                
                                // Set selected location
                                updateSelectedLocation({lat, lng});
                            }
                        }
                        
                        // Update location when map is clicked
                        locationPickerMap.on('click', function(e) {
                            if (locationMarker) {
                                locationMarker.setLatLng(e.latlng);
                            } else {
                                locationMarker = L.marker(e.latlng, {
                                    draggable: true
                                }).addTo(locationPickerMap);
                                
                                // Update location info when marker is dragged
                                locationMarker.on('dragend', function(e) {
                                    updateSelectedLocation(e.target.getLatLng());
                                });
                            }
                            
                            updateSelectedLocation(e.latlng);
                        });
                        
                    } catch (error) {
                        console.error('Error initializing map:', error);
                        alert('Error initializing map. Please try again.');
                    }
                }, 300);
            } else {
                // Just resize the existing map
                setTimeout(() => {
                    locationPickerMap.invalidateSize(true);
                }, 100);
            }
            
            // Setup location search
            setupLocationSearch();
            
            // Setup current location button
            setupCurrentLocationButton();
        }
        
        // Setup location search functionality
        function setupLocationSearch() {
            const locationSearch = document.getElementById('location-search');
            const locationSearchBtn = document.getElementById('location-search-btn');
            const suggestionsContainer = document.getElementById('location-suggestions');
            
            // Search when button is clicked
            locationSearchBtn.addEventListener('click', () => {
                searchLocation(locationSearch.value);
            });
            
            // Search when Enter key is pressed
            locationSearch.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchLocation(locationSearch.value);
                }
            });
            
            // Show real-time suggestions as user types
            locationSearch.addEventListener('input', function() {
                // Debounce to avoid too many API requests
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    const query = this.value.trim();
                    if (query.length < 3) {
                        suggestionsContainer.classList.remove('active');
                        return;
                    }
                    
                    // Show loading in suggestions
                    suggestionsContainer.innerHTML = '<div class="suggestion-item">Searching...</div>';
                    suggestionsContainer.classList.add('active');
                    
                    // Search for locations using Nominatim
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                suggestionsContainer.innerHTML = '';
                                data.forEach(location => {
                                    const suggestionItem = document.createElement('div');
                                    suggestionItem.className = 'suggestion-item';
                                    suggestionItem.textContent = location.display_name;
                                    
                                    // Use this suggestion when clicked
                                    suggestionItem.addEventListener('click', () => {
                                        locationSearch.value = location.display_name;
                                        suggestionsContainer.classList.remove('active');
                                        
                                        // Update map and marker
                                        const lat = parseFloat(location.lat);
                                        const lng = parseFloat(location.lon);
                                        
                                        if (locationPickerMap) {
                                            locationPickerMap.setView([lat, lng], 15);
                                            
                                            // Update or add marker
                                            if (locationMarker) {
                                                locationMarker.setLatLng([lat, lng]);
                                            } else {
                                                locationMarker = L.marker([lat, lng], {
                                                    draggable: true
                                                }).addTo(locationPickerMap);
                                                
                                                locationMarker.on('dragend', function(e) {
                                                    updateSelectedLocation(e.target.getLatLng());
                                                });
                                            }
                                            
                                            // Update selected location
                                            updateSelectedLocation({lat, lng});
                                        }
                                    });
                                    
                                    suggestionsContainer.appendChild(suggestionItem);
                                });
                            } else {
                                suggestionsContainer.innerHTML = '<div class="suggestion-item">No results found</div>';
                            }
                        })
                        .catch(error => {
                            console.error('Error searching for locations:', error);
                            suggestionsContainer.innerHTML = '<div class="suggestion-item">Error searching</div>';
                        });
                }, 300);
            });
            
            // Close suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!suggestionsContainer.contains(e.target) && e.target !== locationSearch) {
                    suggestionsContainer.classList.remove('active');
                }
            });
        }
        
        // Setup current location button
        function setupCurrentLocationButton() {
            const useCurrentLocationBtn = document.getElementById('use-current-location');
            
            useCurrentLocationBtn.addEventListener('click', () => {
                if (!navigator.geolocation) {
                    alert('Geolocation is not supported by your browser');
                    return;
                }
                
                // Change button state
                useCurrentLocationBtn.disabled = true;
                useCurrentLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting...';
                
                navigator.geolocation.getCurrentPosition(
                    // Success callback
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Reset button
                        useCurrentLocationBtn.disabled = false;
                        useCurrentLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Use My Current Location';
                        
                        // Update map with location
                        if (locationPickerMap) {
                            locationPickerMap.setView([lat, lng], 15);
                            
                            // Update or add marker
                            if (locationMarker) {
                                locationMarker.setLatLng([lat, lng]);
                            } else {
                                locationMarker = L.marker([lat, lng], {
                                    draggable: true
                                }).addTo(locationPickerMap);
                                
                                // Update location info when marker is dragged
                                locationMarker.on('dragend', function(e) {
                                    updateSelectedLocation(e.target.getLatLng());
                                });
                            }
                            
                            // Update selected location
                            updateSelectedLocation({lat, lng});
                        }
                    },
                    // Error callback
                    (error) => {
                        // Reset button
                        useCurrentLocationBtn.disabled = false;
                        useCurrentLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Use My Current Location';
                        
                        let errorMsg = 'Could not detect your location.';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = 'Location access was denied. Please enable location access in your browser.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = 'Location information is unavailable.';
                                break;
                            case error.TIMEOUT:
                                errorMsg = 'Location request timed out.';
                                break;
                        }
                        
                        alert(errorMsg);
                    },
                    // Options
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }
        
        // Update selected location and display
        function updateSelectedLocation(latlng) {
            selectedLocation = latlng;
            
            // Update hidden inputs
            document.getElementById('location-lat').value = latlng.lat;
            document.getElementById('location-lng').value = latlng.lng;
            
            // Update display text
            const selectedLocationText = document.getElementById('selected-location-text');
            selectedLocationText.textContent = "Getting location name...";
            
            // Reverse geocode to get address
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`)
                .then(response => response.json())
                .then(data => {
                    if (data.display_name) {
                        const parts = data.display_name.split(', ');
                        // Take first 3 parts for a shorter display
                        const shortAddress = parts.slice(0, 3).join(', ');
                        selectedLocationText.textContent = shortAddress;
                        
                        // Auto-fill address and PIN code if available
                        if (data.address) {
                            // Try to extract PIN code
                            if (data.address.postcode) {
                                document.getElementById('pin-code').value = data.address.postcode;
                            }
                            
                            // Create a formatted address
                            let formattedAddress = '';
                            
                            if (data.address.road) formattedAddress += data.address.road + ', ';
                            if (data.address.suburb) formattedAddress += data.address.suburb + ', ';
                            if (data.address.city_district) formattedAddress += data.address.city_district + ', ';
                            if (data.address.city) formattedAddress += data.address.city;
                            
                            document.getElementById('location').value = formattedAddress.trim();
                        }
                    } else {
                        selectedLocationText.textContent = `Location at ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
                    }
                })
                .catch(error => {
                    console.error('Error with reverse geocoding:', error);
                    selectedLocationText.textContent = `Location at ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
                });
        }
        
        // Search for location
        function searchLocation(query) {
            if (!query || query.trim() === '') return;
            
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const location = data[0];
                        const lat = parseFloat(location.lat);
                        const lng = parseFloat(location.lon);
                        
                        // Update map view
                        locationPickerMap.setView([lat, lng], 15);
                        
                        // Update or add marker
                        if (locationMarker) {
                            locationMarker.setLatLng([lat, lng]);
                        } else {
                            locationMarker = L.marker([lat, lng], {
                                draggable: true
                            }).addTo(locationPickerMap);
                            
                            // Update location info when marker is dragged
                            locationMarker.on('dragend', function(e) {
                                updateSelectedLocation(e.target.getLatLng());
                            });
                        }
                        
                        // Update selected location
                        updateSelectedLocation({lat, lng});
                    } else {
                        alert('No locations found for your search');
                    }
                })
                .catch(error => {
                    console.error('Error searching for location:', error);
                    alert('Error searching for location');
                });
        }

        // Load product requests
        function loadProductRequests() {
            console.log('Loading product requests...');
            
            // Check if requests were cleared by the user
            const requestsCleared = localStorage.getItem('requestsCleared') === 'true';
            console.log('requestsCleared flag in localStorage:', requestsCleared);
            
            if (requestsCleared) {
                console.log('Requests were previously cleared, showing empty state');
                const requestsContainer = document.getElementById('product-requests-list');
                const requestsCount = document.getElementById('requests-count');
                
                requestsContainer.innerHTML = `
                    <div class="empty-requests">
                        <i class="fas fa-inbox"></i>
                        <p>No product requests yet</p>
                    </div>
                `;
                requestsCount.textContent = '0';
                return;
            }
            
            const requestsContainer = document.getElementById('product-requests-list');
            const requestsCount = document.getElementById('requests-count');
            const currentUserId = firebase.auth().currentUser.uid;

            // Use the current vendor's user ID directly as the store ID since they appear to be the same
            // This is a fix for the "Store ID not found" error
            const vendorId = currentUserId;
            
            // Query product requests for this vendor
            firebase.database().ref('product_requests')
                .orderByChild('storeId')
                .equalTo(vendorId)
                .once('value')
                .then((snapshot) => {
                    // Clear the container
                    requestsContainer.innerHTML = '';

                    if (!snapshot.exists()) {
                        requestsContainer.innerHTML = `
                            <div class="empty-requests">
                                <i class="fas fa-inbox"></i>
                                <p>No product requests yet</p>
                            </div>
                        `;
                        requestsCount.textContent = '0';
                        return;
                    }

                    const requests = [];
                    snapshot.forEach((childSnapshot) => {
                        requests.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    // Sort requests by created time (newest first)
                    requests.sort((a, b) => b.createdAt - a.createdAt);

                    // Update request count badge
                    requestsCount.textContent = requests.length;

                    // Display the requests
                    requests.forEach(request => {
                        const timestamp = request.createdAt ? new Date(request.createdAt) : new Date();
                        const timeString = formatTimeAgo(timestamp);

                        const requestCard = document.createElement('div');
                        requestCard.className = 'request-card';
                        requestCard.setAttribute('data-request-id', request.id);
                        
                        let statusHTML = '';
                        let actionsHTML = '';
                        
                        if (request.status === 'pending') {
                            statusHTML = `<span class="request-status pending">Pending</span>`;
                            actionsHTML = `
                                <div class="request-actions">
                                    <button class="btn btn-danger" onclick="rejectRequest('${request.id}')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                    <button class="btn btn-primary" onclick="showPriceInput('${request.id}')">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                </div>
                                <div id="price-input-${request.id}" class="price-input-wrapper" style="display: none;">
                                    <span>₹</span>
                                    <input type="number" class="price-input" id="price-${request.id}" placeholder="Enter price" min="1" step="0.01">
                                    <button class="btn btn-primary" onclick="approveRequest('${request.id}')">Submit</button>
                                </div>
                            `;
                        } else if (request.status === 'approved') {
                            statusHTML = `<span class="request-status approved">Approved</span>`;
                            const cartStatus = request.addedToCart ? 
                                `<p><strong>Status:</strong> Added to customer's cart</p>` : 
                                `<p><strong>Status:</strong> <span class="warning-text">Not yet in cart</span>`;
                            
                            // Add recovery note if applicable
                            const recoveryNote = request.recoveryAttempt ? 
                                `<p class="debug-note"><small>(Added via recovery attempt)</small></p>` : '';
                            
                            actionsHTML = `
                                <div class="request-details">
                                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                        <div style="width: 50px; height: 50px; background-color: #f8f9fa; border-radius: 5px; display: flex; align-items: center; justify-content: center; margin-right: 10px; overflow: hidden;">
                                            <img src="${request.imageURL || 'images/default-product.png'}" 
                                                 alt="Product Icon" 
                                                 style="width: 100%; height: 100%; object-fit: cover;"
                                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/50?text=📦'; this.style.padding='5px';">
                                        </div>
                                        <div>
                                            <p><strong>Price:</strong> ₹${typeof request.price === 'number' ? request.price.toFixed(2) : parseFloat(request.price).toFixed(2)}</p>
                                            ${cartStatus}
                                            ${recoveryNote}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (request.status === 'rejected') {
                            statusHTML = `<span class="request-status pending">Rejected</span>`;
                        }

                        requestCard.innerHTML = `
                            <div class="request-header">
                                <div class="request-title">${request.productName}</div>
                                ${statusHTML}
                            </div>
                            <div class="request-user">
                                <i class="fas fa-user"></i>
                                <div>Requested by ${request.userName || 'Anonymous'}</div>
                                <div class="request-time">${timeString}</div>
                            </div>
                            <div class="request-details">
                                <p><strong>Quantity:</strong> ${request.quantity}</p>
                                ${request.description ? `<p><strong>Description:</strong> ${request.description}</p>` : ''}
                            </div>
                            ${actionsHTML}
                        `;
                        
                        requestsContainer.appendChild(requestCard);
                    });
                })
                .catch((error) => {
                    console.error('Error loading product requests:', error);
                    requestsContainer.innerHTML = `
                        <div class="empty-requests">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error loading requests: ${error.message}</p>
                        </div>
                    `;
                });
        }

        // Function to show price input field when approving a request
        function showPriceInput(requestId) {
            const priceInput = document.getElementById(`price-input-${requestId}`);
            priceInput.style.display = 'flex';
        }

        // Function to reject a product request
        function rejectRequest(requestId) {
            if (confirm('Are you sure you want to reject this product request?')) {
                // Get optional reason
                const reason = prompt('Please provide a reason for rejecting (optional):');
                
                // Use ProductRequestSystem to reject the request
                ProductRequestSystem.rejectProductRequest(requestId, reason)
                    .then(() => {
                        // Show notification
                        ProductRequestSystem.showNotification({
                            title: 'Request Rejected',
                            message: 'You have rejected this product request.',
                            type: 'info',
                            duration: 5000
                        });
                        
                        // Reload the requests
                        loadProductRequests();
                    })
                    .catch((error) => {
                        console.error('Error rejecting request:', error);
                        alert('Error rejecting request: ' + error.message);
                    });
            }
        }

        // Function to approve a product request
        function approveRequest(requestId) {
            const priceInput = document.getElementById(`price-${requestId}`);
            const price = parseFloat(priceInput.value);
            
            if (isNaN(price) || price <= 0) {
                alert('Please enter a valid price.');
                return;
            }
            
            // Show loading state
            const submitBtn = document.querySelector(`#price-input-${requestId} .btn-primary`);
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            submitBtn.disabled = true;
            
            // Use ProductRequestSystem to approve the request
            ProductRequestSystem.approveProductRequest(requestId, price)
                .then(() => {
                    console.log('Request approved successfully');
                    
                    // Show success message
                    ProductRequestSystem.showNotification({
                        title: 'Request Approved',
                        message: `You've approved this product request and added it to the customer's cart.`,
                        type: 'success',
                        duration: 5000
                    });
                    
                    // Reset button state
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                    
                    // Reload the requests
                    loadProductRequests();
                })
                .catch((error) => {
                    console.error('Error approving request:', error);
                    alert('Error approving request: ' + error.message);
                    
                    // Reset button state
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                });
        }

        // Clean up any buggy products that were added to store by mistake
        function cleanupBuggyProducts() {
            const currentUserId = firebase.auth().currentUser.uid;
            
            // Get all product requests that were approved
            firebase.database().ref('product_requests')
                .orderByChild('storeId')
                .equalTo(currentUserId)
                .once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) return;
                    
                    // For each approved request, remove the corresponding product from vendor_products
                    const requestsToCheck = [];
                    snapshot.forEach((childSnapshot) => {
                        const request = childSnapshot.val();
                        if (request.status === 'approved' && request.requestId) {
                            requestsToCheck.push({
                                id: childSnapshot.key,
                                requestId: request.requestId
                            });
                        }
                    });
                    
                    // Remove products that were added by bug
                    if (requestsToCheck.length > 0) {
                        return firebase.database().ref(`vendor_products/${currentUserId}`).once('value')
                            .then((productsSnapshot) => {
                                if (!productsSnapshot.exists()) return;
                                
                                const promises = [];
                                productsSnapshot.forEach((productSnapshot) => {
                                    const product = productSnapshot.val();
                                    if (product.isFromRequest && product.requestId) {
                                        // This was added by the bug, so remove it
                                        promises.push(
                                            firebase.database().ref(`vendor_products/${currentUserId}/${productSnapshot.key}`).remove()
                                        );
                                    }
                                });
                                
                                if (promises.length > 0) {
                                    return Promise.all(promises);
                                }
                            });
                    }
                })
                .catch((error) => {
                    console.error('Error cleaning up buggy products:', error);
                });
        }

        // Helper function to format time ago
        function formatTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'Just now';
            }
            
            const diffInMinutes = Math.floor(diffInSeconds / 60);
            if (diffInMinutes < 60) {
                return `${diffInMinutes} ${diffInMinutes === 1 ? 'minute' : 'minutes'} ago`;
            }
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) {
                return `${diffInHours} ${diffInHours === 1 ? 'hour' : 'hours'} ago`;
            }
            
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) {
                return `${diffInDays} ${diffInDays === 1 ? 'day' : 'days'} ago`;
            }
            
            return date.toLocaleDateString();
        }
        
        // Function to debug cart issues
        function debugCartIssue(userId) {
            if (!userId) {
                console.error('Cannot debug cart: No user ID provided');
                return;
            }
            
            console.log(`Checking cart for user: ${userId}`);
            
            // Check if user exists
            firebase.database().ref(`users/${userId}`).once('value')
                .then(userSnapshot => {
                    if (userSnapshot.exists()) {
                        console.log('User exists in database');
                    } else {
                        console.log('User does not exist in database');
                    }
                    
                    // Check if cart exists
                    return firebase.database().ref(`carts/${userId}`).once('value');
                })
                .then(cartSnapshot => {
                    if (cartSnapshot.exists()) {
                        console.log('Cart exists with data:', cartSnapshot.val());
                        
                        const cartData = cartSnapshot.val();
                        let cartItems = [];
                        
                        // Check both structures: old direct items and new structure with 'items' property
                        if (cartData.items) {
                            console.log('Found items in correct structure (items property)');
                            Object.keys(cartData.items).forEach(key => {
                                cartItems.push({
                                    id: key,
                                    ...cartData.items[key]
                                });
                            });
                        } else {
                            // Look for items directly in the cart root
                            console.log('Checking for items at cart root level (old structure)');
                            cartSnapshot.forEach(childSnapshot => {
                                const item = childSnapshot.val();
                                if (item && typeof item === 'object' && (item.productName || item.price)) {
                                    cartItems.push({
                                        id: childSnapshot.key,
                                        ...item
                                    });
                                }
                            });
                            
                            if (cartItems.length > 0) {
                                console.log('Found items at root level, cart structure needs migration');
                                
                                // Fix cart structure
                                const fixedItems = {};
                                cartItems.forEach(item => {
                                    fixedItems[item.id] = {
                                        productName: item.productName,
                                        quantity: item.quantity,
                                        price: item.price,
                                        storeId: item.storeId,
                                        storeName: item.storeName,
                                        imageURL: item.imageURL || 'https://via.placeholder.com/300x300?text=Custom+Request',
                                        isCustom: item.isCustom,
                                        requestId: item.requestId,
                                        addedAt: item.addedAt,
                                        migrated: true
                                    };
                                });
                                
                                // Update cart structure
                                firebase.database().ref(`carts/${userId}`).set({ items: fixedItems })
                                    .then(() => console.log('Cart structure fixed successfully'))
                                    .catch(error => console.error('Error fixing cart structure:', error));
                            }
                        }
                        
                        console.log('Cart items count:', cartItems.length);
                        if (cartItems.length > 0) {
                            console.table(cartItems);
                        } else {
                            console.log('No items found in cart');
                        }
                        
                        return cartItems;
                    } else {
                        console.log('Cart does not exist for this user');
                        return [];
                    }
                })
                .catch(error => {
                    console.error('Error debugging cart:', error);
                });
        }

        // Function to force add an item to cart
        function forceAddToCart(requestId) {
            const requestCardElement = document.querySelector(`[data-request-id="${requestId}"]`);
            if (requestCardElement) {
                requestCardElement.classList.add('processing');
            }
            
            // Get the request data
            firebase.database().ref(`product_requests/${requestId}`).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        throw new Error('Request not found');
                    }
                    
                    const requestData = snapshot.val();
                    if (!requestData.userId) {
                        throw new Error('User ID not found in request');
                    }
                    
                    if (!requestData.price) {
                        throw new Error('Price not set for this request');
                    }
                    
                    // Create cart item
                    const cartItemData = {
                        productName: requestData.productName,
                        quantity: parseInt(requestData.quantity) || 1,
                        price: requestData.price,
                        storeId: requestData.storeId,
                        storeName: requestData.storeName,
                        imageURL: requestData.imageURL || 'https://via.placeholder.com/300x300?text=Custom+Request',
                        isCustom: true,
                        requestId: requestId,
                        addedAt: firebase.database.ServerValue.TIMESTAMP,
                        forceAdded: true
                    };
                    
                    // Check if the cart already exists
                    return firebase.database().ref(`carts/${requestData.userId}`).once('value')
                        .then(cartSnapshot => {
                            const cartData = cartSnapshot.val() || {};
                            
                            // Get the 'items' property or create it if it doesn't exist
                            const cartItems = cartData.items || {};
                            
                            // Generate a unique key for the item
                            const itemKey = firebase.database().ref().push().key;
                            
                            // Add the new item to the items object
                            cartItems[itemKey] = cartItemData;
                            
                            // Update the cart with the new items object
                            return firebase.database().ref(`carts/${requestData.userId}`).update({
                                items: cartItems
                            });
                        })
                        .then(() => {
                            // Update request status
                            return firebase.database().ref(`product_requests/${requestId}`).update({
                                addedToCart: true
                            });
                        });
                })
                .then(() => {
                    alert('Item has been successfully added to customer\'s cart');
                    if (requestCardElement) {
                        requestCardElement.classList.remove('processing');
                    }
                    loadProductRequests(); // Refresh the list
                })
                .catch(error => {
                    console.error('Error forcing item to cart:', error);
                    alert('Error: ' + error.message);
                    if (requestCardElement) {
                        requestCardElement.classList.remove('processing');
                    }
                });
        }

        // Function to automatically check and fix cart issues
        function autoFixCartIssues() {
            console.log('Auto-fixing cart issues...');
            const currentUserId = firebase.auth().currentUser.uid;
            
            // Find approved requests that aren't showing as added to cart
            firebase.database().ref('product_requests')
                .orderByChild('storeId')
                .equalTo(currentUserId)
                .once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) return;
                    
                    const requestsToFix = [];
                    snapshot.forEach(childSnapshot => {
                        const request = childSnapshot.val();
                        if (request.status === 'approved' && !request.addedToCart) {
                            requestsToFix.push({
                                id: childSnapshot.key,
                                ...request
                            });
                        }
                    });
                    
                    console.log(`Found ${requestsToFix.length} requests to fix`);
                    
                    if (requestsToFix.length > 0) {
                        // Fix each request
                        const fixPromises = requestsToFix.map(request => {
                            return new Promise((resolve, reject) => {
                                // Check if it's actually in the cart already
                                firebase.database().ref(`carts/${request.userId}`).once('value')
                                    .then(cartSnapshot => {
                                        let foundInCart = false;
                                        
                                        if (cartSnapshot.exists()) {
                                            cartSnapshot.forEach(cartItem => {
                                                if (cartItem.val().requestId === request.id) {
                                                    foundInCart = true;
                                                }
                                            });
                                        }
                                        
                                        if (foundInCart) {
                                            // It's in cart but not marked as such, just update the flag
                                            return firebase.database().ref(`product_requests/${request.id}`).update({
                                                addedToCart: true
                                            }).then(() => resolve());
                                        } else {
                                            // Not in cart, add it
                                            const cartItemData = {
                                                productName: request.productName,
                                                quantity: parseInt(request.quantity) || 1,
                                                price: request.price,
                                                storeId: request.storeId,
                                                storeName: request.storeName,
                                                imageURL: request.imageURL || 'https://via.placeholder.com/300x300?text=Custom+Request',
                                                isCustom: true,
                                                requestId: request.id,
                                                addedAt: firebase.database.ServerValue.TIMESTAMP,
                                                autoFixed: true
                                            };
                                            
                                            // Check if the cart already exists
                                            return firebase.database().ref(`carts/${request.userId}`).once('value')
                                                .then(cartSnapshot => {
                                                    const cartData = cartSnapshot.val() || {};
                                                    
                                                    // Get the 'items' property or create it if it doesn't exist
                                                    const cartItems = cartData.items || {};
                                                    
                                                    // Generate a unique key for the item
                                                    const itemKey = firebase.database().ref().push().key;
                                                    
                                                    // Add the new item to the items object
                                                    cartItems[itemKey] = cartItemData;
                                                    
                                                    // Update the cart with the new items object
                                                    return firebase.database().ref(`carts/${request.userId}`).update({
                                                        items: cartItems
                                                    });
                                                })
                                                .then(() => {
                                                    return firebase.database().ref(`product_requests/${request.id}`).update({
                                                        addedToCart: true
                                                    });
                                                })
                                                .then(() => resolve());
                                        }
                                    })
                                    .catch(error => {
                                        console.error(`Error fixing request ${request.id}:`, error);
                                        reject(error);
                                    });
                            });
                        });
                        
                        Promise.all(fixPromises)
                            .then(() => {
                                console.log('Auto-fix completed successfully');
                                loadProductRequests(); // Refresh the display
                            })
                            .catch(error => {
                                console.error('Error during auto-fix:', error);
                            });
                    }
                })
                .catch(error => {
                    console.error('Error checking for cart issues:', error);
                });
        }

        // Function to clear all product requests (frontend only)
        function clearAllRequests() {
            console.log('clearAllRequests function called');
            
            // Show custom confirmation dialog
            const confirmationDialog = document.getElementById('confirmation-dialog');
            confirmationDialog.classList.add('show');
            
            // Set up event listeners for the dialog buttons
            const cancelButton = document.getElementById('cancel-clear');
            const confirmButton = document.getElementById('confirm-clear');
            
            // Remove any existing event listeners
            const newCancelButton = cancelButton.cloneNode(true);
            const newConfirmButton = confirmButton.cloneNode(true);
            cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
            
            // Handle cancel
            newCancelButton.addEventListener('click', function() {
                confirmationDialog.classList.remove('show');
                console.log('User cancelled clearing requests');
            });
            
            // Handle confirm
            newConfirmButton.addEventListener('click', function() {
                confirmationDialog.classList.remove('show');
                
                try {
                    console.log('User confirmed clearing all requests');
                    
                    const requestsContainer = document.getElementById('product-requests-list');
                    const requestsCount = document.getElementById('requests-count');
                    
                    if (!requestsContainer || !requestsCount) {
                        console.error('Required DOM elements not found');
                        return;
                    }
                    
                    // Clear the container
                    requestsContainer.innerHTML = `
                        <div class="empty-requests">
                            <i class="fas fa-inbox"></i>
                            <p>No product requests yet</p>
                        </div>
                    `;
                    
                    // Reset the count
                    requestsCount.textContent = '0';
                    
                    // Store in localStorage that requests were cleared
                    localStorage.setItem('requestsCleared', 'true');
                    console.log('Requests cleared and localStorage flag set');
                    
                    // Show in-page notification
                    showToast(
                        'Requests Cleared',
                        'All product requests have been cleared from your view.',
                        'info'
                    );
                } catch (error) {
                    console.error('Error in clearAllRequests:', error);
                    showToast('Error', error.message, 'error');
                }
            });
        }
        
        // Show notification function
        function showNotification(title, message, type = 'success') {
            if (typeof ProductRequestSystem !== 'undefined' && ProductRequestSystem.showNotification) {
                ProductRequestSystem.showNotification({
                    title: title,
                    message: message,
                    type: type,
                    duration: 3000
                });
            } else {
                alert(`${title}: ${message}`);
            }
        }

        // Function to reset the requests view - clear localStorage flag and reload
        function resetRequestsView() {
            console.log('Resetting requests view...');
            
            // Remove the flag from localStorage
            localStorage.removeItem('requestsCleared');
            console.log('requestsCleared flag removed from localStorage');
            
            // Show in-page notification
            showToast(
                'Requests Reset',
                'Requests view has been reset. Loading requests again.',
                'success'
            );
            
            // Load product requests again
            loadProductRequests();
        }

        // Function to show in-page toast notification
        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('vendor-toast');
            const toastTitle = toast.querySelector('.vendor-toast-title');
            const toastMessage = toast.querySelector('.vendor-toast-message');
            const toastIcon = toast.querySelector('.vendor-toast-icon i');
            const closeBtn = document.getElementById('toast-close');
            
            // Set content
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Set icon based on type
            toast.className = 'vendor-toast'; // Reset classes
            toast.classList.add(type); // Add type class
            
            // Set proper icon
            if (type === 'success') {
                toastIcon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                toastIcon.className = 'fas fa-exclamation-circle';
            } else if (type === 'info') {
                toastIcon.className = 'fas fa-info-circle';
            }
            
            // Close button handler
            closeBtn.onclick = function() {
                toast.classList.remove('show');
            };
            
            // Show toast
            toast.classList.add('show');
            
            // Hide after 3 seconds
            let toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
            
            // Clear timeout if close button is clicked
            closeBtn.addEventListener('click', function() {
                clearTimeout(toastTimeout);
            });
        }
    </script>
    
    <!-- Add the product request system JS -->
    <script src="js/product-request-system.js"></script>
</body>
</html> 